<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Manager</title>
  </head>
  <body>
    <script src="https://unpkg.com/decap-cms@^3.4.0/dist/decap-cms.js"></script>
    <script>
      // Transliteration map for Cyrillic characters
      const translitMap = {
        а: "a", б: "b", в: "v", г: "g", д: "d", е: "e", ё: "yo",
        ж: "zh", з: "z", и: "i", й: "y", к: "k", л: "l", м: "m",
        н: "n", о: "o", п: "p", р: "r", с: "s", т: "t", у: "u",
        ф: "f", х: "h", ц: "ts", ч: "ch", ш: "sh", щ: "sch", ъ: "",
        ы: "y", ь: "", э: "e", ю: "yu", я: "ya"
      };

      function generateSlug(title) {
        if (!title) return Math.random().toString(36).substring(2, 10);

        const transliterate = (str) => {
          return str
            .toLowerCase()
            .split("")
            .map((char) => translitMap[char] || char)
            .join("");
        };

        const baseSlug = transliterate(title)
          .toLowerCase()
          .replace(/[^\w\s-]/g, "")
          .replace(/\s+/g, "-")
          .replace(/-+/g, "-")
          .trim();

        return `${baseSlug}-${Math.random().toString(36).substring(2, 8)}`;
      }

      CMS.registerEventListener({
        name: 'preSave',
        handler: async ({ entry }) => {
          const bookTitle = entry.get('params').get('bookTitle');

          // Generate and set the slug
          const slug = generateSlug(bookTitle);
          entry = entry.set('slug', slug);

          // Set the title to match bookTitle
          entry = entry.set('title', bookTitle);

          return entry;
        },
      });
    </script>
  </body>
</html>